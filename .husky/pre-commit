#!/usr/bin/env sh

# File: .husky/pre-commit
# Purpose: Run full quality gates before committing changes (tests & CI checks).
# All Rights Reserved. Arodi Emmanuel

echo "ğŸš€ Pre-commit checks starting..."

# i18n fast-fail (generate + verify catalogs & keys) - BEFORE formatting
echo "ğŸ“‹ Generating i18n keys..."
npm --prefix poetry-frontend run i18n:gen || {
  echo "âŒ i18n key generation failed!"
  exit 1
}

echo "âœ… Verifying i18n catalogs..."
npm --prefix poetry-frontend run i18n:verify || {
  echo "âŒ i18n catalog verification failed!"
  exit 1
}

# Format first
echo "ğŸ¨ Formatting files..."
npx --no lint-staged || {
  echo "âŒ File formatting failed!"
  exit 1
}

# Then lint separately (after format, avoiding conflicts)
echo "ğŸ” Linting code..."
npm --prefix poetry-frontend run lint:fix -- --max-warnings=0 || {
  echo "âŒ Linting failed! Check the output above for specific file errors."
  exit 1
}

# Fast repo-level checks
echo "ğŸ“ Checking line limits..."
node tools/ci/check-lines.mjs || {
  echo "âŒ Line limit check failed! Check the output above for specific file and line violations."
  exit 1
}

echo "ğŸ“‹ Checking file headers..."
node tools/ci/check-headers.mjs || {
  echo "âŒ Header check failed! Check the output above for files missing headers."
  exit 1
}

echo "ğŸŒ Scanning i18n usage..."
node tools/ci/i18n-scan.mjs || {
  echo "âŒ i18n scan failed! Check the output above for hardcoded strings."
  exit 1
}

# Type safety
echo "ğŸ”¤ Type checking..."
npm run typecheck || {
  echo "âŒ Type check failed! Check the output above for specific type errors in files."
  exit 1
}

# Tests (explicit: frontend then backend)
echo "ğŸ§ª Running frontend tests..."
npm run test:frontend || {
  echo "âŒ Frontend tests failed! Check the output above for specific test failures."
  exit 1
}

echo "ğŸ§ª Running backend tests..."
npm run test:backend || {
  echo "âŒ Backend tests failed! Check the output above for specific test failures."
  exit 1
}

# API contract & SDK integrity
echo "ğŸ“‹ Validating OpenAPI contract..."
npm run openapi:validate || {
  echo "âŒ OpenAPI validation failed! Check the output above for contract errors."
  exit 1
}

echo "ğŸ”„ Checking SDK sync..."
npm run sdk:check || {
  echo "âŒ SDK check failed! Run 'npm run sdk:sync' to fix OpenAPI drift."
  exit 1
}

# Explicit builds to fail fast on build errors
# Frontend build (uses package in poetry-frontend)
echo "ğŸ—ï¸ Building frontend..."
npm --prefix poetry-frontend run build || {
  echo "âŒ Frontend build failed! Check the output above for build errors."
  exit 1
}

# Backend build (Maven package; skip tests for speed)
echo "ğŸ—ï¸ Building backend..."
(cd poetry-backend && mvn -q -DskipTests package) || {
  echo "âŒ Backend build failed! Check the output above for compilation errors."
  exit 1
}

# Module structure validation
# echo "ğŸ—ï¸ Validating module structure..."
# npm run modules:check || {
#   echo "âŒ Module structure check failed! Check the output above for missing files/folders."
#   echo "   Run 'npm run modules:check' to see detailed report."
#   exit 1
# }

echo "âœ… All pre-commit checks passed!"
