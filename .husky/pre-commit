#!/usr/bin/env sh

# File: .husky/pre-commit
# Purpose: Run full quality gates before committing changes (tests & CI checks).
# All Rights Reserved. Arodi Emmanuel

echo "ğŸš€ Pre-commit checks starting..."

# === FASTEST CHECKS FIRST (< 2 seconds) ===
# These checks analyze existing files without compilation/transformation

echo "ğŸ“‹ Checking file headers..."
node tools/ci/headers/check-headers.mjs || {
  echo "âŒ Header check failed! Check the output above for files missing headers."
  exit 1
}

# Run SDK extraction checker to enforce extractSdkData pattern
echo "ğŸ” Checking SDK extraction pattern..."
node tools/ci/sdk/check-sdk-extraction.mjs || {
  echo "âŒ SDK extraction pattern violations found! Use extractSdkData() instead of inline extraction."
  exit 1
}

echo " Checking hardcoded colors..."
node tools/ci/colors/check-hardcoded-colors.mjs || {
  echo "âŒ Color check failed! Use theme CSS variables instead of hardcoded colors."
  exit 1
}

echo "ï¿½ğŸŒ Scanning i18n usage..."
node tools/ci/i18n/i18n-scan.mjs || {
  echo "âŒ i18n scan failed! Check the output above for hardcoded strings."
  exit 1
}

echo "ğŸ“‹ Validating OpenAPI contract..."
npm run validate:openapi || {
  echo "âŒ OpenAPI validation failed! Check the output above for contract errors."
  exit 1
}

echo "ğŸ”„ Checking SDK sync..."
npm run check:sdk-sync || {
  echo "âŒ SDK check failed! Run 'npm run sdk:generate' to fix OpenAPI drift."
  exit 1
}

echo "ğŸ—ï¸ Validating module structure..."
npm run modules:check || {
  echo "âŒ Module structure check failed! Check the output above for missing files/folders."
  echo "   Run 'npm run modules:check' to see detailed report."
  echo "   This ensures all features follow the required DDD module structure."
  echo "   Implement missing files/folders as needed."
  exit 1
}

# === MEDIUM SPEED TASKS (2-10 seconds) ===
# These tasks process and transform files

echo "ğŸ“‹ Generating i18n keys..."
npm --prefix poetry-frontend run i18n:gen || {
  echo "âŒ i18n key generation failed!"
  exit 1
}

echo "âœ… Verifying i18n catalogs..."
npm --prefix poetry-frontend run i18n:verify || {
  echo "âŒ i18n catalog verification failed!"
  exit 1
}

# Skip lint-staged for TS/JS - ESLint handles it below
# Only format JSON/YAML configs
echo "ğŸ¨ Formatting config files..."
npx lint-staged --no-stash 2>/dev/null || true

echo "ğŸ¨ Linting frontend code..."
npm --prefix poetry-frontend run lint:fix -- --max-warnings=0 || {
  echo "âŒ Frontend linting failed! Check the output above for specific file errors."
  exit 1
}

echo "ğŸ¨ Linting backend code..."
npm run lint:backend || {
  echo "âŒ Backend linting failed! Check the output above for specific file errors."
  exit 1
}

# Moved to end to reduce refactor churn during iterative typing changes
echo "ğŸ“ Checking line limits..."
node tools/ci/limits/check-lines.mjs || {
  echo "âŒ Apply necesary line limits! "
  exit 1
}

echo "âœ… All pre-commit checks passed!"
