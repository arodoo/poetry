<!--
File: 13.2-backend-offline-fonts-imp-details.md
Purpose: Detailed supplemental material for Task 13.2 backend offline fonts
         implementation (extracted to keep main task file <80 lines).
All Rights Reserved.
-->

# Task 13.2 â€“ Backend Offline Fonts (Detailed Supplement)

## Architectural Weaknesses & Triggers

| Area                    | Weakness            | Early Mitigation           | Trigger                   |
| ----------------------- | ------------------- | -------------------------- | ------------------------- |
| DB Naming               | No convention       | Add blueprint section      | Before fifth table        |
| Extensibility           | No variants/subsets | Reserve fields arrays      | Need italic/variable      |
| Integrity Trust         | Only hash           | Add integrity column       | Security review/CDN shift |
| Token Bloat             | Monolith payload    | Set <15KB gzip budget      | Budget or p95>150ms       |
| Concurrency             | Last write wins     | Add selectionVersion draft | Race detection            |
| Preload Uniqueness      | Not enforced        | Validator + test           | Invariant failure         |
| Seeder Drift            | One-shot seed       | Track seed version         | New fonts post launch     |
| Fingerprint Sensitivity | Over broad          | Restrict semantic subset   | Non-semantic churn        |
| Cache Abstraction       | Impl-first risk     | Port first                 | SW layering               |
| Offline First Run       | Possible FOUT       | Deterministic preload      | Reported FOUT             |
| Host Allowlist          | Too permissive      | Add allowlist config       | Security audit            |
| Removal Logic           | Desync risk         | Atomic eviction flow       | User mismatch reports     |

Immediate Improvements Executed: semantic hashing restriction, preload default
seeding, integrity column, naming alignment.

Deferred Tickets: modular tokens endpoint, per-user font selection, SW
background sync + metrics, variable font axes/subsets.

## Full Future Extensions Notes

1. Per-user selection: introduce join table `user_font_selection` keyed by user
   id.
2. Seed versioning: add `seed_version` configuration row to allow additive font
   introduction without re-running entire seed.
3. Admin CRUD: expose secured endpoints (role: PLATFORM_ADMIN) for font
   add/retire (v2).

## Risks & Mitigations (Full Table)

| Risk                      | Mitigation                                          |
| ------------------------- | --------------------------------------------------- |
| Large font files          | Enforce size cap (<500KB) & lazy registration       |
| Hash false mismatch       | Dual check integrity + hash, warn-only phase        |
| Storage quota             | Explicit eviction UI + deterministic fallback font  |
| Multiple preload defaults | Invariant test + future DB unique partial index     |
| Browser cache eviction    | Re-assert preloadDefault on startup path            |
| CDN tampering             | Integrity verification + host allowlist             |
| Payload growth            | Monitor gzip size, split fonts endpoint if > budget |
| Race on selection         | Optional version token in update request (future)   |
| Seed drift                | Maintain seed version & delta migrations            |

## Full Actual Result

Implemented Backend Artifacts:

1. Persistence: `font_assets` JPA entity + weights collection table, integrity
   column present.
2. Domain: `FontAsset` record validates key/url/hash/label; factory method for
   creation.
3. Seeding: `FontAssetSeeder` adds Inter (preloadDefault=true) and Roboto;
   idempotent via presence check.
4. Ports/Adapter: Query + Command ports with `FontAssetJpaAdapter` filtering
   active & not deleted.
5. Provider: `FontAssetsFontsProvider` now primary bean (replaces hardcoded
   provider).
6. DTO + OpenAPI: `preloadDefault`, `integrity` fields added; explicit schema
   replacement for fonts list.
7. Fingerprint: Updated to hash key, hash value, weights, preload flag only.
8. Selection Fallback: Use case updated to prefer preloadDefault when no stored
   selection.
9. Tests: `UITokensPreloadDefaultFontSelectionTest`,
   `UITokensFontsFingerprintTest` ensure behavior.
10. Build Quality: All tests green; style & Checkstyle pass.

Deferred Backend Items:

- Runtime validator for multiple preload defaults beyond test coverage.
- Metrics (`ui_tokens_fonts_total`, `ui_tokens_preload_default_key`).
- Host allowlist enforcement logic.
- CRUD endpoints for font lifecycle.

Outcome: Stable backend contract enabling frontend offline caching
implementation without further backend breaking changes.

End of supplemental details.
