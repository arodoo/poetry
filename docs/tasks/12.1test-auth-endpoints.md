<!--
File: 12.1test-auth-endpoints.md
Purpose: Comprehensive manual + automated verification plan and captured responses for Auth v1 endpoints. Documents request/response pairs, success and failure cases, correlation + idempotency headers, rate limiting and lockout behavioral observations, and JWT/refresh rotation flows. Provides repeatable test matrix to ensure contract stability and operational readiness (metrics & rotation job). All Rights Reserved. Arodi Emmanuel
-->

# Task 12.1: Test & Document Auth Endpoints (/api/v1/auth)

## Objective

Execute and document exhaustive test matrix for login, register, refresh,
logout, including security behaviors (idempotency, rate limiting, lockout, key
rotation overlap) and error mappings (401, 409, 423, 429). Capture canonical
request/response examples for docs and regression.

## Scope

Endpoints: /register, /login, /refresh, /logout. Cross-cutting: headers
(Correlation-Id, Idempotency-Key), metrics emission, secret age job visibility
(audit), adaptive penalty & lockout timing.

## Test Environment Assumptions

- H2 in-memory DB (clean per test class).
- Default AuthProperties as in application test config.
- Time control via injected clock or deterministic wait utilities.

## Test Matrix (Summary)

1. Registration success + idempotent replay (same Idempotency-Key returns
   identical 201 body, no duplicate user).
2. Registration duplicate email without Idempotency-Key => 409.
3. Email normalization (MixedCase -> lower stored).
4. Password policy rejection (too short) => 400 mapped problem.
5. Login success -> access + refresh tokens (validate iss, sub, exp, jti,
   rotation fields).
6. Login invalid password increments rate limiter but not lockout threshold yet.
7. Adaptive rate limiter penalty escalation after consecutive bursts -> 429.
8. Account lockout triggers after configured failures -> 423 until backoff
   window elapses.
9. Lockout cooldown exponential windows verified (timing assertions with
   margin).
10. Combined limiter + lockout precedence (lockout returns 423 even if limiter
    would 429).
11. Refresh success rotates refresh (old invalidated) and returns new pair.
12. Refresh reuse of old token => 401 misuse invalidation path.
13. Refresh with mismatched subject/audience (if supported) => 401.
14. Key rotation overlap: tokens signed with previous key still accepted within
    overlap seconds.
15. Key rotation age policy breach prevented at startup (validation test).
16. Logout revokes active refresh (subsequent refresh => 401) idempotent
    repeat 204.
17. Metrics counters increment: auth_requests_total, lockout_events_total,
    rate_limit_exceeded_total (names illustrative) observed via publisher mock
    or in-memory registry.
18. SecretAgeRotationJob emits gauge (secret_age_seconds) and audit event every
    5m tick (simulated clock advance).

## Example Requests & Responses

Registration (201): POST /api/v1/auth/register Headers: Correlation-Id: c-123,
Idempotency-Key: idem-abc Body:
{"email":"User@Example.com","password":"StrongPass!9"} Response: 201
{"userId":"...","email":"user@example.com"} Replay same headers/body => 201
identical body.

Duplicate (409): same email different Idempotency-Key => 409 problem+json
code=USER_ALREADY_EXISTS.

Login (200): returns accessToken (short TTL), refreshToken (long TTL),
tokenType=Bearer. Invalid creds => 401 problem+json code=INVALID_CREDENTIALS.
Rate limited => 429 problem+json code=RATE_LIMIT_EXCEEDED. Locked => 423
problem+json code=ACCOUNT_LOCKED.

Refresh (200): new access/refresh; old refresh invalidated. Reuse old => 401
code=INVALID_REFRESH.

Logout (204): no body. Replay => 204.

## Metrics Observation Procedure

1. Invoke sequence generating failures to trigger limiter & lockout.
2. Query /actuator/metrics for published names (or inspect registry bean in
   test) and assert counter increments.
3. Advance simulated clock for rotation job, verify secret_age_seconds gauge
   present and audit event persisted.

## Automation Strategy

- Leverage existing advanced test classes; extend if missing scenarios above.
- Add parameterized tests for escalation windows and rotation overlap
  boundaries.
- Use custom TestClock (if not existing) else configurable sleep with margin.<

## Pending Additions (If Needed)

- Add test utilities for metric snapshot diff.
- Add sample curl collection (future docs export) if requested.

## Status

Initial documentation scaffold created; verify against code & expand with
concrete JSON fragments copied from actual test outputs after execution.
