/_ File: 13.2-frontend-twaling-library-config.md Purpose: Task plan to port
legacy UI components (oldRepo/boops-site/app/src/ui) into the new Poetry
frontend following Tailwind token, theming, i18n, a11y, DDD, and formatting
rules. Includes integration of themes, colors, and fonts provided by the
backend, full token centralization, and decoupled customization. All Rights
Reserved. _/

# Task 13.2 Frontend Tailwind UI Library Config & Migration

Font-specific offline caching, preload, switching, integrity and eviction logic
has been extracted to `13.2-frontend-font-config.md` to keep concerns isolated.
This document now focuses on structural UI library migration, theming (colors),
sizing tokens, spacing, radius, shadows, a11y, i18n, and component refactors.
Themes, fonts, sizes, spacings, radii, and shadows are all admin only.

**Goal:** Migrate legacy components 'oldRepo\boops-site\app\src\features\theme'
&& 'oldRepo\boops-site\app\src\ui' to `poetry-frontend/src/ui/` as a
foundational UI library with fully decoupled, combinable customization of colors
(10 themes x 12 colors), fonts (at least 3, available offline), font sizes,
spacings, radii, and shadows. The system must be 100% token-driven, accessible,
i18n-ready, free from business logic and hardcoded styles/text, with files <80
lines, and all tokens downloaded and centralized from the backend.

---

## 0. Backend Tokens & Customization Integration Prep

- [ ] Backend must expose a `/health` endpoint with a `getTokens` method that
      returns each customization as a **separate group**:
  - **themes:** 10 color themes, each with 12 named colors (e.g. primary,
    secondary, accent, info, warning, error, success, surface, background,
    border, muted, text).
    - (fonts moved – see font task doc)
  - **fontSizes:** at least 5 sizes (xs, sm, base, lg, xl), each set identified
    by key (e.g. `default`, `compact`, `spacious`).
  - **fontWeights:** global set (normal, medium, bold).
  - **spacings:** named sets for spacing (xs, sm, md, lg, xl), each set
    identified by key.
  - **radius:** sets of border-radius (sm, md, lg), each identified by key.
  - **shadows:** sets of shadows (sm, md, lg), each identified by key.
- [ ] Backend must support independent updates for color theme, font, font size
      set, spacing set, radius set, and shadow set. The frontend never defines
      or alters these sets, only consumes those that are selected and available.
- [ ] Backend must expose the currently selected value for each type (e.g.
      currentTheme, currentFont, currentSpacing, etc).
- [ ] Document the `getTokens` contract and how each active customization is
      retrieved and selected.

**Example payload for `getTokens`:**

```json
{
  "themes": [
    { "key": "default", "label": "Default", "colors": { "primary": "#4f46e5", ... } },
    { "key": "dark", "label": "Dark", "colors": { "primary": "#22223b", ... } }
    // ...total 10 themes
  ],
  "fonts": [
    {
      "key": "Inter",
      "label": "Inter",
      "woff2Url": "https://cdn.myapp.com/fonts/inter.woff2",
      "weights": [400, 500, 700],
      "hash": "sha256-abc123"
    },
    {
      "key": "Roboto",
      "label": "Roboto",
      "woff2Url": "https://cdn.myapp.com/fonts/roboto.woff2",
      "weights": [400, 500, 700],
      "hash": "sha256-def456"
    }
  ],
  "fontSizes": [
    { "key": "default", "label": "Default", "sizes": { "xs": "0.75rem", "sm": "0.875rem", "base": "1rem", "lg": "1.125rem", "xl": "1.25rem" } },
    { "key": "compact", "label": "Compact", "sizes": { ... } }
  ],
  "spacings": [
    { "key": "default", "label": "Default", "values": { "xs": "0.25rem", "sm": "0.5rem", "md": "1rem", "lg": "1.5rem", "xl": "2rem" } },
    { "key": "spacious", "label": "Spacious", "values": { ... } }
  ],
  "radius": [
    { "key": "default", "label": "Default", "values": { "sm": "0.125rem", "md": "0.375rem", "lg": "0.5rem" } }
  ],
  "shadows": [
    { "key": "default", "label": "Default", "values": { "sm": "...", "md": "...", "lg": "..." } }
  ],
  "current": {
    "theme": "default",
    "font": "Inter",
    "fontSize": "default",
    "spacing": "default",
    "radius": "default",
    "shadow": "default"
  }
}
```

---

## 1. Audit Checker

- [ ] Inventory legacy components (Alert, Badge, Button, Card, ...).
- [ ] For each: document props, behaviors, styling patterns, a11y gaps, and i18n
      needs.
- [ ] Flag any direct use of color/font/size/spacing/typography/border/shadow to
      be replaced with centralized tokens from the backend.

## 2. Theming & Tokens Checker

- [ ] Define the central tokens mapping in `src/ui/theme/tokens.ts`,
      initializing from the backend payload. // Font preload, download, offline,
      selector moved to font config task.
- [ ] Allow dynamic, decoupled selection of color theme, font, font size set,
      spacing set, radius set, shadow set, etc.
- [ ] Consume tokens only from the backend (`getTokens` via SDK). // Font hash
      invalidation + fallbacks moved to font config task.
- [ ] All visual properties must be replaceable via centralized
      tokens/theme/font/spacing.
- [ ] The frontend must never define, update, or persist tokens: only consume
      the current ones from the backend.

## 3. Structure & DDD Checker

- [ ] Create a folder `src/ui/<Component>/` per component (index +
      Component.tsx + types if needed).
- [ ] Only pure presentational logic; side-effects and navigation outside.
- [ ] Central barrel `src/ui/index.ts` exporting stable contracts.
- [ ] Split files >80 lines (`types.ts`, `subparts/*.tsx`).
- [ ] All components must consume only props and centralized tokens.

## 4. i18n Checker

- [ ] No hardcoded labels; replace with `useT()` keys (namespace `ui.*`).
- [ ] Add/merge keys into `shared/i18n/catalog/*/common/ui.ts` (create if
      absent).
- [ ] Fallbacks for optional props strictly via keys.

## 5. Accessibility (a11y) Checker

- [ ] Buttons: proper `type`, focus ring tokens, aria-disabled vs disabled as
      needed.
- [ ] Inputs/Select: associate `id` & `label`, expose `aria-invalid` on error.
- [ ] Modal: role, aria-modal, focus trap placeholder (advanced trap if separate
      task), close button label key.
- [ ] Table: semantic `<thead>/<tbody>`, optional caption via prop + i18n key.
- [ ] Icons: decorative -> `aria-hidden="true"`, informative -> support `title`
      prop.

## 6. Props & Types Checker

- [ ] Strong explicit prop names (no single-letter vars).
- [ ] Export interfaces separately for reuse/testing.
- [ ] No prop accepting raw class fragments for critical styling (allow
      `className` only for layout extensions).

## 7. Testing & Quality Checker

- [ ] Add vitest tests per component (smoke + variant class resolution + a11y
      attrs) in `src/ui/<Component>/__tests__/` (<40 lines each).
- [ ] Validate env & i18n initialization in tests (mock translation hook).
- [ ] ESLint + Prettier conformity (run existing config). // Font/offline test
      coverage moved to font config task file.

## 8. Documentation Checker

- [ ] Update this file's "Actual Result" section when finished.
- [ ] Create `/docs/domains/ui-library.md` documenting: scope, RFs, data model
      (props), accessibility, i18n, theming (including how tokens/fonts are
      consumed from the backend), and acceptance criteria.
- [ ] Document token integration and decoupling: how tokens are obtained from
      the backend, how they are applied, how each customization type is updated,
      and how user selection is offered.

---

## Expected Result

Fully reusable, theme-aware, 100% token-driven UI component library with
decoupled customization (colors, fonts, sizes, spacings, radii, shadows), fonts
downloaded and available offline, tests, docs, and i18n integration. Frontend
never defines or mutates tokens, only consumes the current set, and everything
works offline once downloaded.

## Actual Result

- Core scaffolding and initial vertical slice implemented: - Tokens feature: Zod
  schemas for bundle + groups, API wrapper with ETag conditional logic, TanStack
  Query hook, and `TokensProvider` applying CSS variables for theme color
  tokens. - Tailwind + PostCSS pipeline active; Tailwind config maps to CSS vars
  for colors. - Manual SDK abstraction (`createSdk`) encapsulates fetch client;
  no direct fetch usage in UI/components. - Role-based guard `RequireRole` with
  tests; routes extended for `adminTokens` and `unauthorized`; BrowserRouter
  integrated. - Admin tokens page renders JSON bundle states
  (loading/error/empty) using i18n keys; Unauthorized page implemented. - UI
  primitives (Button, Alert, Text) created leveraging tokens/Tailwind; tests
  cover variant class presence and accessibility basics. - i18n catalogs (en/es)
  updated for new routes/pages; key coverage tests passing. - All new source
  files <80 lines; test files <40 lines; strict TypeScript with descriptive
  identifiers. - Full test suite green (31 tests) and lint clean at this
  milestone.

Remaining for full migration scope: - Import and refactor remaining legacy
components (Badge, Card, Modal, Table, Forms, etc.) into token-driven versions
with a11y & i18n. - Implement dynamic selection UI for
theme/font/fontSize/spacing/radius/shadow (admin controls) once corresponding
token groups fully surfaced in provider. - Extend TokensProvider to apply font
sizes, spacings, radii, shadows, and fonts (after offline font task completion)
and add tests. - Create `/docs/domains/ui-library.md` final version (currently
draft) detailing props contracts & acceptance criteria per component. - Add i18n
keys for component internal labels (e.g. button loading text, alert aria labels)
under `ui.*` namespace. - Conduct comprehensive a11y audit (focus states
tokenization, aria attributes for complex widgets) and add related tests. -
Introduce story/demo pages or MDX (if chosen) for visual regression and design
reference.

---

## Backend Tokens & Theme Verification (2025-09-04)

Status: READY for frontend implementation.

Adjustments Performed:

- Added `key` field to Theme REST responses (`ThemeDtos.ThemeResponse`) and
  mapper now emits stable semantic key (e.g. `default`, `dark`).
- Updated OpenAPI `Theme` schema to include required `key` and corrected
  `fontWeights` items type to `string`.
- Removed duplicate `ETag` header on `/api/v1/tokens` by making global
  `ETagResponseAdvice` skip when controller already sets one.

Verified Endpoints:

- `GET /api/v1/themes` → 200, includes 10 themes each with
  `id,key,name,active,colors`.
- `GET /api/v1/tokens` → 200 with groups: themes, fonts, fontWeights, fontSizes,
  spacings, radius, shadows, current.
- Conditional GET works: subsequent request with `If-None-Match` returns 304 and
  single `ETag` header.

Sample `GET /api/v1/tokens` (truncated groups for brevity):

```json
{
      "themes": [ { "key": "amber", "label": "Amber", "colors": { "primary": "hsl(34 65% 37%)", "background": "hsl(45 96% 89%)", "text": "hsl(32 69% 27%)" } }, ...],
      "fonts": [ { "key": "inter", "label": "Inter", "weights": [400,500,700], "hash": "sha256-abc123" } ],
      "fontWeights": ["400","500","700"],
      "fontSizes": [ { "key": "default", "label": "Default", "sizes": { "xs": "0.75rem", "sm": "0.875rem", "base": "1rem", "lg": "1.125rem", "xl": "1.25rem" } } ],
      "spacings": [ { "key": "default", "label": "Default", "values": { "xs": "0.25rem", "sm": "0.5rem", "md": "1rem", "lg": "1.5rem", "xl": "2rem" } } ],
      "radius": [ { "key": "default", "label": "Default", "values": { "sm": "0.125rem", "md": "0.375rem", "lg": "0.5rem" } } ],
      "shadows": [ { "key": "default", "label": "Default", "values": { "sm": "0 1px 2px 0 rgb(0 0 0 / 0.05)", "md": "0 4px 6px -1px rgb(0 0 0 / 0.1)", "lg": "0 10px 15px -3px rgb(0 0 0 / 0.1)" } } ],
      "current": { "theme": "amber", "font": "inter", "fontSize": "default", "spacing": "default", "radius": "default", "shadow": "default" }
}
```

Next Frontend Steps:

1. Implement SDK call for `/api/v1/tokens` with ETag caching strategy (React
   Query + conditional `If-None-Match`).
2. Hydrate Tailwind config / runtime CSS variables from token payload.
3. Build font preloading & offline caching (use `hash` for invalidation).
4. Implement token context & selectors referencing stable keys only.

Acceptance Gate: All above backend verifications must remain green; any schema
change must update this doc and OpenAPI before frontend consumption.

---

## 9. Partial Completion Notes

- [ ] (In Progress) Decide minimal vertical slice: implement only 2 themes, 1
      font, current selections, omit others initially for contract scaffolding.
- [x] (Done) Add OpenAPI path `/v1/tokens` with schemas: TokenTheme, TokenFont,
      TokenBundle (slice subset) + ETag header.
- [x] (Done) Backend: domain models ColorTheme, FontAsset; service
      TokensQueryService returning static slice; controller GET /api/v1/tokens.
- [x] (Done) Frontend: provisional SDK method getTokens() + Zod schema.
- [x] (Done) Introduced TokensRepository port + InMemoryTokensRepository impl +
      refactored TokensQueryService to depend on abstraction (production-ready,
      no prototype wording).
- [ ] (Next) Add frontend react-query integration + token context provider.
