<!--
File: 13.2-frontend-font-config.md
Purpose: Frontend implementation plan for offline font caching, selection,
         integrity verification & rollout (split from backend doc).
All Rights Reserved.
-->

# Task 13.2 – Frontend Font Configuration & Offline Strategy

Source Split: Extracted from backend-focused `13.2-offline-fonts-imp.md` to
isolate UI concerns.

## 1. Scope & Goals

- Preload one guaranteed offline default font (`preloadDefault=true`).
- Atomic switch workflow: download → verify → register → persist selection
  (backend endpoint).
- Offline-first startup: render with cached font; avoid layout shift.
- Eviction UI and fallback logic (revert to preload default if current removed).
- Minimize unnecessary re-downloads (use hash + ETag conditional GET).

Non Goals: per-user override (system-level only), font subset optimization,
background sync (deferred).

## 2. Data Inputs

Consumed from `/api/v1/tokens`:

- fonts[]: { key, label, woff2Url, weights[], hash, preloadDefault, integrity? }
- current.font (system selection)
- ETag for conditional revalidation.

## 3. Core Abstractions

1. `FontCachePort` interface
   - Methods: get(key) -> ArrayBuffer|undefined, put(key, buf, meta),
     evict(key), list(), has(key).
   - Implementation: IndexedDB (db: `ui-font-cache`, store: `fonts`, versioned).
     Memory fallback for unsupported browsers.
2. `FontDownloader`
   - Enforces HTTPS, size cap (e.g. 500KB), fetches ArrayBuffer.
   - Integrity (warn-only): if `integrity` present and mismatched vs `hash`
     (sha256-...), log + reject (future strict mode).
3. `FontRegistrar`
   - Creates `FontFace` objects per weight, loads them, appends to
     `document.fonts`.
   - Adds root class `font-loaded-<key>` upon success (swap CSS variable set if
     needed).
4. `FontSelectionService`
   - Orchestrates switch: ensure cached or download & register, call selection
     save endpoint (future), then refetch tokens.

## 4. Bootstrap Flow

1. Fetch tokens (ETag conditional if previously stored fingerprint).
2. Identify preload default font.
3. If not cached: download, register, cache.
4. Apply UI class; proceed rendering.
5. Schedule lazy verification (optional) for integrity mismatch logging.

## 5. Switch Flow

1. User selects font key.
2. If cached → register (if not already) → persist selection.
3. Else download → integrity check → register → cache → persist.
4. Refetch tokens (conditional) to confirm `current.font` matches.

## 6. Eviction Flow

1. User chooses font to remove.
2. If font == current → fallback to preload default before removal.
3. Remove from cache; revoke any in-memory references (optional future: detach
   class if not default).
4. Log metrics event.

## 7. Offline Behavior

- On offline startup: attempt cached preload default; if absent use system
  fallback font (CSS stack) and queue download when online.
- Listen for `online` event to resume queued downloads.

## 8. Integrity & Security

- Enforce HTTPS scheme.
- Host allowlist in config (array of allowed font hosts) – reject otherwise.
- Warn-only integrity mismatch path; error mode behind feature flag later.

## 9. Metrics & Logging

- `font_download_success_total`
- `font_download_failure_total`
- `font_cache_hit_total`
- `font_cache_miss_total`
- `font_integrity_mismatch_total`
- Optional performance mark: time from navigation start to font ready.

## 10. Tests (Vitest)

- Cache port: put/get/list/evict.
- Downloader: success, size limit, HTTPS rejection, integrity mismatch.
- Registrar: idempotent registration, multiple weights.
- Bootstrap: populates default, sets class, avoids duplicate download.
- Switch: downloads missing font, persists after registration.
- Eviction: falls back if current.
- Offline startup: cached path vs fallback.

## 11. Rollout Phases

1. Ship cache + downloader behind feature flag (`fontsOffline=true`).
2. Enable preload bootstrap (observe metrics <2% failures).
3. Activate switch + eviction UI.
4. Turn on integrity warning; later enforce.
5. Document final outcome in both docs and close acceptance items AC4–AC7.

## 12. Acceptance Criteria (Frontend Slice)

- [ ] AC4 Default font preloaded on first load.
- [ ] AC5 Switch downloads before persisting selection.
- [ ] AC6 Offline startup uses cached default.
- [ ] AC7 Eviction fallback works.
- [ ] Metrics logging present (success/failure/hit/miss).

## 13. Future Enhancements

- Service worker background font warm & eviction recovery.
- Subset / variable font axis negotiation.
- Per-user font selections.
- Strict integrity enforcement.

## 14. Cross Reference

Backend domain, persistence & hashing plan: see `13.2-offline-fonts-imp.md`.

End of frontend font configuration plan.
