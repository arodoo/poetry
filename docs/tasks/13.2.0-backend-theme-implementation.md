# Task 13.2.0 – Backend Theme Implementation

## Status

In Progress (seeding + dynamic provider integrated)

## Context

The frontend task 13.2 (twaling library config) needs dynamic theme data. Old
repository contains an initial implementation under
`oldRepo/boops-site/api/.../features/theme` with entity `Theme`, repository,
service, seeding, and controller using a legacy structure.

New backend adopts DDD + Clean Architecture with layers:

- domain (pure models, aggregates, domain services)
- application (use cases / ports)
- infrastructure (adapters: JPA, seeders, persistence)
- interfaces (REST controllers / DTO mapping)

Current code exposes hardcoded UI tokens (`UITokens*Provider`). We must replace
hardcoded themes with dynamic persisted themes while preserving existing
structure and adding RFC7807 error handling, soft delete, seeding, and
activation logic.

## Goals

1. Persist themes with soft delete and audit fields.
2. Expose versioned REST endpoints under `/api/v1/themes` matching new
   conventions.
3. Provide active theme and list of themes for UI tokens endpoint – UI Tokens
   controller should delegate to application service instead of hardcoded
   provider.
4. Migrate seeding logic (10 default themes) into infrastructure seeder executed
   at startup (idempotent).
5. Provide application layer ports & services (list, get, create, update,
   activate, delete, restore, recreate defaults).
6. Enforce constraints: name required, colors non-empty map (keys <= 30 chars,
   values valid hex #RGB/#RRGGBB or any css variable placeholder like `var(` in
   future), only one active theme at a time.
7. Provide tests (unit for application service + integration for repository).
   All test files < 40 lines.
8. Update documentation (this file) with actual results after implementation.
9. Keep each file <= 80 lines (backend limit 100 but stay concise). Split where
   needed (e.g. validation helper, mapper).
10. Replace hardcoded themes provider with adapter using repository data; keep
    interface DTO shape unchanged.

## Non-Goals

- Frontend changes (handled in task 13.2).
- Advanced filtering/pagination.

## Risks / Mitigations

- Over-length files -> split into helper classes.
- Seeding runs twice -> enforce count check & transactional guard.

## Deliverables

- Domain model `Theme`.
- Domain value object / validation for color map.
- Ports: `ThemeQueryPort`, `ThemeCommandPort`.
- Application service `ThemeApplicationService` (use cases) + `ThemeSeeder` use
  case.
- Infrastructure JPA entity `JpaTheme`, colors element collection, repository
  `SpringDataThemeRepository`, adapter implementing ports.
- Seeder runner `ThemeStartupSeeder` (ApplicationReady event).
- REST controller `ThemeController` + DTOs + mapper + error handling using
  existing problem details mechanism.
- Update `UITokensThemesProvider` to fetch from service or replace with
  `DynamicUITokensThemesProvider`.
- Tests.
- Update status section with Actual Result.

## Steps

1. Create domain model & validation utilities.
2. Define ports in application layer.
3. Implement application service with transactional annotations.
4. Create JPA entity + repository + adapter implementation.
5. Implement seeding service & startup runner.
6. Implement REST controller + DTO/message mapping.
7. Refactor UI tokens provider to call application service (injectable bean) –
   keep controller minimal.
8. Write unit tests for service logic (activation uniqueness, validation fail
   cases).
9. Write integration test for repository soft delete & restore.
10. Run tests & adjust.
11. Document Actual Result and mark status Completed.

## Acceptance Criteria

- GET /api/v1/themes returns list (200) excluding soft-deleted.
- GET /api/v1/themes/active returns single active theme.
- POST creates theme (201) inactive by default.
- PUT /{id}/activate ensures only that theme active.
- Soft delete endpoint marks deletedAt timestamp; not returned afterwards.
- Seeder creates exactly 10 themes on empty DB; re-run does not duplicate.
- UI tokens endpoint returns seeded themes.

## Actual Result

Partial implementation complete:

- Domain model, ports, use cases implemented.
- JPA entity, repository, adapter implemented.
- Spring composition wiring added (`ThemeComposition`).
- Dynamic UI tokens provider now pulls persisted themes.
- Seeder + startup listener created (currently seeds 2 themes if none).
- REST controller implemented. Remaining: tests, problem detail errors, extend
  seeding to 10 themes, documentation finalization, OpenAPI update.
