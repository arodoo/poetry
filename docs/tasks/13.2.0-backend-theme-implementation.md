# Task 13.2.0 â€“ Backend Theme Implementation

## Status

Completed (Updated after base not-found refactor)

## Context

The frontend task 13.2 (twaling library config) needs dynamic theme data. Old
repository contains an initial implementation under
`oldRepo/boops-site/api/.../features/theme` with entity `Theme`, repository,
service, seeding, and controller using a legacy structure.

New backend adopts DDD + Clean Architecture with layers:

- domain (pure models, aggregates, domain services)
- application (use cases / ports)
- infrastructure (adapters: JPA, seeders, persistence)
- interfaces (REST controllers / DTO mapping)

Current code exposed hardcoded UI tokens. We replaced hardcoded themes with
persisted themes while preserving structure and adding RFC7807 error handling,
soft delete, seeding, activation logic.

## Goals (Recap vs Result)

1. Persist themes with soft delete. DONE (deletedAt in entity, filtered
   queries).
2. Versioned REST endpoints `/api/v1/themes`. DONE.
3. Active theme + list consumed by UI tokens. DONE (dynamic provider).
4. Seeding logic (10 default themes) idempotent. DONE.
5. Ports & individual use cases. DONE.
6. Constraints enforced (name, colors, single active). DONE (validator +
   activate use case).
7. Tests (core CRUD, activation uniqueness, extended validation, not-found).
   DONE.
8. Documentation updated. DONE (this file + domain + OpenAPI).
9. Files <= 80 lines (or close). DONE.
10. Hardcoded provider removed. DONE (deprecated empty files remain for diff).
11. Color format migrated to modern HSL (with fallback hex/var() allowed). DONE.

## Deliverables Implemented

- Domain model `Theme`, validator helper for invariants (+ HSL/hex/var pattern).
- Ports `ThemeQueryPort`, `ThemeCommandPort`.
- Use cases: get all/by id/active, create, update, delete (soft), activate.
- Infrastructure: `ThemeEntity`, `ThemeJpaRepository`, `ThemeJpaAdapter`,
  mapper, factory (if needed), seeder, startup runner.
- Interfaces: `ThemeController` (+ NOT_FOUND handler), DTOs, dynamic UI tokens
  integration.
- Config: `ThemeComposition` wiring all beans.
- OpenAPI: Added schemas + paths for themes (collection, item, activate,
  active).
- Domain doc `themes.md` updated earlier; parity confirmed.

## API Summary

- GET /api/v1/themes -> 200 JSON array Theme
- GET /api/v1/themes/active -> 200 Theme (404 if none)
- GET /api/v1/themes/{id} -> 200 Theme (404 if not found)
- POST /api/v1/themes -> 201 Theme (inactive)
- PUT /api/v1/themes/{id} -> 200 Theme
- PUT /api/v1/themes/{id}/activate -> 200 Theme (ensures single active)
- DELETE /api/v1/themes/{id} -> 204 (soft delete)

## Seeding

`ThemeSeeder` inserts 10 curated themes on empty store (idempotent) using HSL
color syntax for modern design systems.

## Error Handling

Domain validation exceptions propagate to global problem handler (RFC7807). Not
found now uses `ThemeNotFoundException` extending `AbstractNotFoundException`
with unified 404 + i18n key `error.theme.not-found` (implemented in later
refactor and integrated here retroactively). Global handler rethrows annotated
exceptions preserving 404.

## Completion Confirmation

Task completed.
