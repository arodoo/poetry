<!--
File: 13.2-offline-fonts-imp.md
Purpose: Detailed implementation plan to deliver offline-first font
			management & persistence for UI token system.
All Rights Reserved.
-->

# Task 13.2 – Offline Fonts Backend Implementation (Refined)

## Layer 0: Context & Intent

Need: offline-safe default font + stable tokens contract; hash-driven cache
invalidation; additive schema. Goals: (1) single preload default (2) persisted
selection surfaced (3) atomic switch path (4) eviction fallback (5) minimal
additive fields (6) semantic fingerprint (7) future CRUD readiness. Non-goals:
per-user overrides, font subsets, multi-CDN fallback now.

## Layer 1: Domain & Persistence Foundation

Entity: FontAsset(key,label,url,hash,weights,preloadDefault,active,integrity?)
Actions: (1) table `font_assets` + entity/repo (2) seed single preloadDefault
(3) validator (future stronger) (4) selection persistence supports font key (5)
optional `integrity` column.

Acceptance Mapping: AC1 (table+seed), AC2 (preload flag), Risk: Multiple preload
defaults mitigated.

## Layer 2: Backend Exposure & Fingerprint

Steps: expose preload/integrity (DTO+OpenAPI); fingerprint only
key+hash+weights+preload+selection; tests (preload fallback, fingerprint
semantics); filter inactive.

Acceptance Mapping: AC2, AC3.

// Frontend implementation (previous Layers 3–7) moved to
`13.2-frontend-font-config.md`. // This file now focuses strictly on backend
domain, persistence, tokens exposure, // fingerprinting and backend-side
acceptance.

## Layer 3: Backend Security & Integrity Scope

Security: integrity column (optional), semantic fingerprint, HTTPS-only seed,
future host allowlist.

## Layer 4: Backend Observability

1. Add debug log hooks (future) when tokens served (font count, preload key).
2. Metric placeholders: `ui_tokens_fonts_total`, `ui_tokens_preload_default_key`
   gauge.
3. Log warning if more than one preloadDefault detected (should not happen if
   invariant test passes).

## Layer 5: Backend Rollout & Versioning

Steps: schema+seed; expose fields; tests; document & handoff.

## Layer 8: Architectural Weaknesses (Summary)

See details file for full weaknesses list (naming, integrity, payload,
concurrency, preload uniqueness, drift, fingerprint, layering, offline,
allowlist, removal).

## Layer 9: Acceptance Criteria (Mapped)

- [x] AC1 Domain table + seed (Layer 1) -> `FontAssetEntity`, `FontAssetSeeder`.
- [x] AC2 preloadDefault surfaced (Layer 2) -> DTO fields + OpenAPI fonts
      schema.
- [x] AC3 ETag changes on hash/selection (Layer 2) ->
      `TokensFingerprintUpdater` + tests.
- [ ] (Frontend) AC4 Default font preloaded (see 13.2-frontend-font-config)
- [ ] (Frontend) AC5 Switch downloads before persisting selection (frontend doc)
- [ ] (Frontend) AC6 Offline startup uses cached default (frontend doc)
- [ ] (Frontend) AC7 Eviction fallback works (frontend doc)
- [x] AC8 Code quality: naming, no TODOs, style checks pass.
- [x] AC9 Documentation updated with actual result (this edit).

## Layer 10: Future Extensions (Summary)

Per-user selection, seed versioning, admin CRUD (see details file).

## Layer 11: Key Risks (Summary)

Key: size cap, integrity path, quota eviction, preload invariant, cache
re-check, CDN integrity.

## Layer 12: Actual Result (Summary)

Implemented: persistence, seed (single preload), domain, adapter, provider swap,
DTO+OpenAPI, semantic fingerprint, selection fallback, tests, green build.
Deferred: runtime uniqueness validator, metrics, allowlist, CRUD. Outcome:
backend stable for frontend rollout (see details file for full results).
